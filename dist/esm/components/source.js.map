{"version":3,"sources":["../../../src/components/source.js"],"names":["PropTypes","React","cloneElement","useContext","useEffect","useMemo","useRef","useState","assert","deepEqual","MapContext","propTypes","type","string","isRequired","id","sourceCounter","createSource","map","props","style","_loaded","options","children","addSource","getSource","updateSource","source","prevProps","changedKey","changedKeyCount","key","setData","data","updateImage","url","coordinates","setCoordinates","setUrl","setTiles","tiles","console","warn","Source","context","propsRef","setStyleLoaded","forceUpdate","version","on","off","requestAnimationFrame","allLayers","getStyle","layers","layer","removeLayer","removeSource","undefined","current","Children","child"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport * as PropTypes from 'prop-types';\nimport * as React from 'react';\nimport { cloneElement, useContext, useEffect, useMemo, useRef, useState } from 'react';\nimport assert from '../utils/assert';\nimport deepEqual from '../utils/deep-equal';\nimport MapContext from './map-context';\n\nconst propTypes = {\n  type: PropTypes.string.isRequired,\n  id: PropTypes.string\n};\n\nlet sourceCounter = 0;\n\nfunction createSource(map, id, props) {\n  if (map && map.style && map.style._loaded) {\n    const options = {...props};\n    delete options.id;\n    delete options.children;\n    map.addSource(id, options);\n    return map.getSource(id);\n  }\n  return null;\n}\n\n/* eslint-disable complexity */\nfunction updateSource(source, props, prevProps) {\n  assert(props.id === prevProps.id, 'source id changed');\n  assert(props.type === prevProps.type, 'source type changed');\n\n  let changedKey = '';\n  let changedKeyCount = 0;\n\n  for (const key in props) {\n    if (key !== 'children' && key !== 'id' && !deepEqual(prevProps[key], props[key])) {\n      changedKey = key;\n      changedKeyCount++;\n    }\n  }\n\n  if (!changedKeyCount) {\n    return;\n  }\n\n  const {type} = props;\n  if (type === 'geojson') {\n    source.setData(props.data);\n  } else if (type === 'image') {\n    source.updateImage({url: props.url, coordinates: props.coordinates});\n  } else if (\n    (type === 'canvas' || type === 'video') &&\n    changedKeyCount === 1 &&\n    changedKey === 'coordinates'\n  ) {\n    source.setCoordinates(props.coordinates);\n  } else if (type === 'vector' && source.setUrl) {\n    // Added in 1.12.0:\n    // vectorTileSource.setTiles\n    // vectorTileSource.setUrl\n    switch (changedKey) {\n      case 'url':\n        source.setUrl(props.url);\n        break;\n      case 'tiles':\n        source.setTiles(props.tiles);\n        break;\n      default:\n    }\n  } else {\n    // eslint-disable-next-line\n    console.warn(`Unable to update <Source> prop: ${changedKey}`);\n  }\n}\n/* eslint-enable complexity */\n\nfunction Source(props) {\n  const context = useContext(MapContext);\n  const propsRef = useRef({id: props.id, type: props.type});\n  const [, setStyleLoaded] = useState(0);\n\n  const id = useMemo(() => props.id || `jsx-source-${sourceCounter++}`, []);\n  const {map} = context;\n\n  useEffect(() => {\n    if (map) {\n      const forceUpdate = () => setStyleLoaded(version => version + 1);\n      map.on('styledata', forceUpdate);\n\n      return () => {\n        map.off('styledata', forceUpdate);\n        /* global requestAnimationFrame */\n        // Do not remove source immediately because the\n        // dependent <Layer>s' componentWillUnmount() might not have been called\n        // Removing source before dependent layers will throw error\n        // TODO - find a more robust solution\n        requestAnimationFrame(() => {\n          if (map.style && map.style._loaded && map.getSource(id)) {\n            // Parent effects are destroyed before child ones, see\n            // https://github.com/facebook/react/issues/16728\n            // Source can only be removed after all child layers are removed\n            const allLayers = map.getStyle()?.layers;\n            if (allLayers) {\n              for (const layer of allLayers) {\n                // @ts-ignore (2339) source does not exist on all layer types\n                if (layer.source === id) {\n                  map.removeLayer(layer.id);\n                }\n              }\n            }\n            map.removeSource(id);\n          }\n        });\n      };\n    }\n    return undefined;\n  }, [map, id]);\n\n  let source = map && map.style && map.getSource(id);\n  if (source) {\n    updateSource(source, props, propsRef.current);\n  } else {\n    source = createSource(map, id, props);\n  }\n  propsRef.current = props;\n\n  return (\n    (source &&\n      React.Children.map(\n        props.children,\n        child =>\n          child &&\n          cloneElement(child, {\n            source: id\n          })\n      )) ||\n    null\n  );\n}\n\nSource.propTypes = propTypes;\nexport default Source;\n"],"file":"source.js"}